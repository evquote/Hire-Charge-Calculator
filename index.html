<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Royal Birmingham Conservatoire — Multi-Venue Quote Calculator</title>
<style>
:root{
  --brand:#002e5b;
  --muted:#6b6b6b;
  --bg:#fafafa;
  --card:#ffffff;
}
body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#222;margin:0;padding:20px;display:flex;justify-content:center;}
.wrapper{max-width:1000px;width:100%;}
header{display:flex;align-items:center;gap:16px;margin-bottom:18px;justify-content:space-between;flex-wrap:wrap;}
h1{font-size:20px;margin:0;color:var(--brand);}
nav{display:flex;gap:10px;align-items:center;}
nav button, nav a.button{background:var(--brand);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;text-decoration:none;}
.card{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(8,24,40,0.06);margin-bottom:14px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
label{display:block;font-size:13px;margin-bottom:6px;}
select,input[type=number]{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;}
.full{grid-column:1/-1;}
fieldset{border:1px solid #eee;padding:10px;border-radius:8px;margin:0;}
.checkbox-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid #fafafa;}
.qty{width:86px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th, td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:var(--brand);color:white;}
#grandTotal, #staffGrandTotal{font-weight:700;font-size:18px;color:var(--brand);text-align:right;margin-top:10px;}
button.mainBtn{background:var(--brand);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;margin-right:6px;}
.muted{color:var(--muted);font-size:13px;}
input[type=text]{width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;}
.hidden{display:none;}

/* ===== Gallery styles ===== */
.gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px;}
.panel{position:relative;cursor:pointer;border-radius:8px;overflow:hidden;box-shadow:0 3px 10px rgba(0,0,0,0.1);transition:transform 0.3s;}
.panel img{width:100%;height:120px;object-fit:cover;display:block;transition:transform 0.3s;}
.panel:hover img{transform:scale(1.05);}
.panel .title{position:absolute;bottom:0;width:100%;background:rgba(0,46,91,0.8);color:white;text-align:center;padding:6px;font-size:14px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:9999;overflow:auto;}
.modal-content{background:white;max-width:800px;width:90%;padding:20px;border-radius:8px;position:relative;overflow-y:auto;max-height:90vh;}
.modal-content img{width:100%;height:auto;border-radius:6px;cursor:pointer;margin-bottom:10px;}
.modal-content .desc{margin-top:10px;color:#222;font-size:14px;}
.modal-close{position:absolute;top:10px;right:10px;background:var(--brand);color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;}
.modal-arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,46,91,0.8);color:white;border:none;padding:10px;border-radius:50%;cursor:pointer;font-size:18px;}
.modal-prev{left:10px;}
.modal-next{right:10px;}

@media (max-width:700px){.grid{grid-template-columns:1fr;}header{flex-direction:column;align-items:flex-start;}}
</style>
</head>
<body>
<div class="wrapper">

<header>
  <div>
    <h1>Royal Birmingham Conservatoire — Multi-Venue Quote</h1>
    <div class="muted">Add multiple venues to generate a combined quote. All prices + VAT.</div>
  </div>
  <nav>
    <button id="venueTab">Venue Quote</button>
    <button id="staffTab">Staffing Costs</button>
    <a href="#" class="button" id="clearSession" style="display:none;">Logout Staffing</a>
  </nav>
</header>

<!-- ===== Venue Gallery ===== -->
<div class="gallery" id="venueGallery">
  <div class="panel" data-venue="Bradshaw">
    <img src="https://img.bcu.ac.uk/_bcuimages/copyright-hufton-crow-24-131600593110714462.jpg" alt="Bradshaw Hall" onerror="this.src='https://placehold.co/300x200/002e5b/white?text=Bradshaw+Hall'">
    <div class="title">Bradshaw Hall</div>
  </div>
  <div class="panel" data-venue="Recital">
    <img src="https://img.bcu.ac.uk/_bcuimages/tom-bird-birmingham-conservatoire-27-131600597991399988.jpg" alt="Recital Hall" onerror="this.src='https://placehold.co/300x200/002e5b/white?text=Recital+Hall'">
    <div class="title">Recital Hall</div>
  </div>
  <div class="panel" data-venue="Jazz">
    <img src="https://img.bcu.ac.uk/_bcuimages/tom-bird-birmingham-conservatoire-25-131600600782377259.jpg" alt="Eastside Jazz Club" onerror="this.src='https://placehold.co/300x200/002e5b/white?text=Jazz+Club'">
    <div class="title">Eastside Jazz Club</div>
  </div>
  <div class="panel" data-venue="Organ">
    <img src="https://img.bcu.ac.uk/_bcuimages/tom-bird-birmingham-conservatoire-8-131600601961613750.jpg" alt="Organ Studio" onerror="this.src='https://placehold.co/300x200/002e5b/white?text=Organ+Studio'">
    <div class="title">Organ Studio</div>
  </div>
  <div class="panel" data-venue="Lab">
    <img src="https://img.bcu.ac.uk/_bcuimages/copyright-hufton-crow-30-131600603623200315.jpg" alt="The Lab" onerror="this.src='https://placehold.co/300x200/002e5b/white?text=The+Lab'">
    <div class="title">The Lab</div>
  </div>
  <div class="panel" data-venue="Workshop">
    <img src="https://img.bcu.ac.uk/_bcuimages/copyright-hufton-crow-2-131600605710728764.jpg" alt="Workshops / Performance Studios" onerror="this.src='https://placehold.co/300x200/002e5b/white?text=Workshops'">
    <div class="title">Workshops / Performance Studios</div>
  </div>
</div>

<!-- ===== VENUE QUOTE SECTION ===== -->
<div id="venuePage">
<div class="card">
  <div class="grid">
    <div class="full">
      <fieldset>
        <legend><strong>Booking Times & Event Day(s)</strong></legend>
        <div class="muted" style="margin-bottom:6px;">
          Please include your full booking time (get-in and get-out). Minimum 4-hour booking applies.<br>
          Regular hours: Mon–Fri 08:00–23:00, Sat–Sun 08:00–19:00.<br>
          After-hours surcharge: £20/hour + VAT applies outside these hours.
        </div>
        <div style="display:flex;gap:10px;margin-bottom:6px;">
          <div style="flex:1">
            <label for="startTime">Booking Start Time</label>
            <select id="startTime"></select>
          </div>
          <div style="flex:1">
            <label for="endTime">Booking End Time</label>
            <select id="endTime"></select>
          </div>
        </div>
        <div style="margin-bottom:6px;">
          <label><strong>Event Day(s)</strong></label>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:4px;">
            <label><input type="checkbox" class="day" value="Mon"> Mon</label>
            <label><input type="checkbox" class="day" value="Tue"> Tue</label>
            <label><input type="checkbox" class="day" value="Wed"> Wed</label>
            <label><input type="checkbox" class="day" value="Thu"> Thu</label>
            <label><input type="checkbox" class="day" value="Fri"> Fri</label>
            <label><input type="checkbox" class="day" value="Sat"> Sat</label>
            <label><input type="checkbox" class="day" value="Sun"> Sun</label>
          </div>
        </div>
      </fieldset>
    </div>

    <div>
      <label for="venue">Venue / Space</label>
      <select id="venue">
        <option value="">— select venue —</option>
        <option value="Bradshaw">Bradshaw Hall</option>
        <option value="Recital">Recital Hall</option>
        <option value="Lab">The Lab</option>
        <option value="Jazz">Eastside Jazz Club</option>
        <option value="Organ">Organ Studio</option>
        <option value="Workshop">Workshop Space</option>
      </select>
    </div>

    <div>
      <label for="hireType">Hire Type</label>
      <select id="hireType">
        <option value="standard">Standard Rate (includes FOH staff)</option>
        <option value="premium">Recording / Premium Workshop (dry hire)</option>
      </select>
    </div>

    <div class="full">
      <fieldset>
        <legend><strong>Technical / Equipment</strong></legend>
        <div class="muted" style="margin-bottom:6px;">Quantity</div>
        <div class="checkbox-row"><div>PA (per day)</div><div><input id="pa_qty" class="qty" type="number" min="0" value="0" /></div></div>
        <div class="checkbox-row"><div>Projector (per day)</div><div><input id="projector_qty" class="qty" type="number" min="0" value="0" /></div></div>
        <div class="checkbox-row"><div>Microphone (wired)</div><div><input id="mic_wired_qty" class="qty"type="number" min="0" value="0" /></div></div>
        <div class="checkbox-row"><div>Microphone (wireless)</div><div><input id="mic_wireless_qty" class="qty" type="number" min="0" value="0" /></div></div>
        <div class="checkbox-row"><div>Monitor</div><div><input id="monitor_qty" class="qty" type="number" min="0" value="0" /></div></div>
        <div class="checkbox-row"><div>Overhead audio recording</div><div><input id="overhead_qty" class="qty" type="number" min="0" value="0" /></div></div>
        <div class="checkbox-row"><div>Static video recording</div><div><input id="video_qty" class="qty" type="number" min="0" value="0" /></div></div>
        <div class="checkbox-row"><div>Laptop</div><div><input id="laptop_qty" class="qty" type="number" min="0" value="0" /></div></div>
        <div class="checkbox-row"><div>Grand Piano</div><div><input id="piano_qty" class="qty" type="number" min="0" value="0" /></div></div>
      </fieldset>
    </div>

    <div class="full" style="margin-top:10px;">
      <button id="addBtn" class="mainBtn">Add to Quote</button>
      <button id="emailBtn" class="mainBtn" style="background-color: #004a9a;">Email Quote</button>
      <button id="downloadBtn" class="mainBtn" style="background-color: #006f71;">Download HTML</button>
    </div>
  </div>
</div>

<div class="card">
<h3 style="margin-top:0">Quote Summary</h3>
<table id="orderTable">
<thead>
<tr>
<th>Venue</th><th>Hire Type</th><th>Hours</th><th>Base (£)</th><th>Equipment (£)</th><th>Subtotal (£)</th><th>VAT (£)</th><th>Total (£)</th><th>After-Hours (£)</th><th>Remove</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div id="grandTotal">Grand Total: £0.00</div>
<div class="muted" style="margin-top:6px;">Technician hours will be quoted separately based on the technical requirements of the event.</div>
<div class="muted" style="margin-top:6px;">After-hours surcharge: £20/hour + VAT applies outside regular opening hours.</div>
<div class="muted">For booking & detailed technical quotes contact: conservatoireevents@bcu.ac.uk</div>
<div class="muted" style="margin-top:8px;"><strong>Disclaimer:</strong> Quote is for reference purposes only. All costs are subject to review.</div>
</div>

<!-- Modal -->
<div id="venueModal" class="modal">
  <div class="modal-content">
    <button class="modal-close">×</button>
    <button class="modal-arrow modal-prev">❮</button>
    <button class="modal-arrow modal-next">❯</button>
    <div id="modalImageContainer"></div>
    <div class="desc" id="modalDesc"></div>
  </div>
</div>

<!-- All JavaScript logic is contained within this script tag -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. DEFINE DATA (Rates & Venue Details) ---

    const VAT_RATE = 0.20;
    const AFTER_HOURS_SURCHARGE_RATE = 20; // £ per hour
    const MIN_BOOKING_HOURS = 4;

    // Venue hire rates (per hour)
    const venueRates = {
        Bradshaw: { standard: 220, premium: 160 },
        Recital: { standard: 150, premium: 110 },
        Lab: { standard: 100, premium: 80 },
        Jazz: { standard: 120, premium: 90 },
        Organ: { standard: 80, premium: 60 },
        Workshop: { standard: 70, premium: 50 }
    };

    // Equipment rates
    const equipmentRates = {
        pa: { rate: 100, perDay: true },
        projector: { rate: 50, perDay: true },
        mic_wired: { rate: 10, perDay: false },
        mic_wireless: { rate: 25, perDay: false },
        monitor: { rate: 15, perDay: false },
        overhead: { rate: 75, perDay: false },
        video: { rate: 75, perDay: false },
        laptop: { rate: 30, perDay: false },
        piano: { rate: 50, perDay: false }
    };

    // Data for the modal gallery
    const venueDetails = {
        Bradshaw:{
            alt: "Bradshaw Hall",
            desc:"The Bradshaw Hall has been acoustically modelled to optimise the experience of performers and to ensure the best auditory experience from every seat. From the soft pallets of the colour scheme to state-of-the-art performance lighting and technical capabilities, each aspect of the hall has been expertly designed to provide an inspiring backdrop for the performances and other activity being presented there. The hall has a raised platform stage with three retractable risers and a stage extension, large enough for a full symphony orchestra. Audience seating graduates across a gentle rake with further seating provided on a small balcony above the back section of the 440 capacity hall. The hall is serviced by an extensive back-of house area with soloist and green rooms and access to our spacious atrium and foyer, and our range of performance studios and function rooms when the hall is booked as part of a larger event.", 
            images:["https://www.tagvenue.com/resize/98/a1/widen-1680-noupsize;68138-bradshaw-hall-room-enhanced-v1-3027435.jpg","http://www.bcu.ac.uk/mediaitem/royal-birmingham-conservatoire-symphony-orchestra-and-chorus-131855489657224296.jpg?quality=90","https://bcuassets.blob.core.windows.net/img/the-bradshaw-hall-131735296676445133.jpg","https://cphfcrflaa.cloudimg.io/_bcuimages/04-07-2024-folk-ensemble-web-133765767100637752.jpg"]
        },
        Recital:{
            alt: "Recital Hall",
            desc:"The intimate Recital Hall has a variable acoustic and is a flexible space with a floor-level stage area. A bleacher seating rake of 146 capacity can be extended for concert set-up, or fully retracted underneath a small technical balcony for other seating and event set-ups including cabaret and theatre style. As with our larger Bradshaw Hall, attention has been paid to every detail in the design of the hall to optimise the experience of both audiences and performers – from the acoustics to the colour scheme of the interior fit-out and from performance lighting to technical capabilities.", 
            images:["https://azure.wgp-cdn.co.uk/app-pianist/posts/Royal-Birmingham-Conservatoire_Charcoalblue_credit-Hufton-and-Crow_lowres-023.jpg?&width=1200&height=630&mode=crop","https://www.association-of-noise-consultants.co.uk/wp-content/uploads/2018/08/RBC-Recital-Hall-Steinway-Piano-min.jpg","https://www.bof.co.uk/assets/images/projects/royal-birmingham-conservatoire/small-4.png"]
        },
        Jazz:{
            alt: "Eastside Jazz Club",
            desc:"Birmingham’s only dedicated Jazz venue, Eastside Jazz Club has been expertly designed to create a quintessential, cosy, jazz club atmosphere. Your guests can relax in style with low – level mood lighting and cabaret setting creating the perfect ambience for an authentic, sophisticated laid-back jazz bar. This is a fully flexible performance space with removable audience seating, tables and bar-stools running across three raised levels to be arranged as required. Choose from a private setting with blackout blinds or open to allow natural light in as desired. While predominantly for the performance of jazz music in all its forms, the venue is also an ideal setting for other types of small music gig as well as spoken word and comedy.", 
            images:["https://img.bcu.ac.uk/_bcuimages/tom-bird-birmingham-conservatoire-25-131600600782377259.jpg", "https://tse1.mm.bing.net/th/id/OIP.rQ4jKYUx7O_SLtJNosUp0wHaCx?pid=Api","https://tse1.mm.bing.net/th/id/OIP.cmNowyLdhr5FQ-WSsRMvaAHaF-?pid=Api"]
        },
        Organ:{
            alt: "Organ Studio",
            desc:"A light and airy venue that is equally suited to chamber and organ performance. The venue has a distinctive shape and tranquil atmosphere created by natural light flooding onto the pale wood of the interior. It is completely flexible in terms of the set-up and layout of the performance area and audience seating. The venue houses a Eule Pipe organ and features overhead performance lighting and Dante audio network for flexible location recording purposes. With access to Steinway model D or model B grand pianos, there is also a wide range of other instruments and equipment available for hire.", 
            images:["https://img.bcu.ac.uk/_bcuimages/copyright-hufton-crow-30-131600603623200315.jpg","https://tse4.mm.bing.net/th/id/OIP.ZqMlPPt9HssFc17TJUyIAHaE8?pid=Api","https://tse1.mm.bing.net/th/id/OIP.Sc1WQGk9lCcNOehBIAWehwHaFj?pid=Api"]
        },
        Lab:{
            alt: "The Lab",
            desc:"The Lab is a cutting edge, completely flexible black-box studio with a technical walkway suspended around the perimeter. The 100 capacity venue has fixed acoustics with a low reverberation time and duplicate input points for a mobile sound desk to be installed at either end of the room. This enables complete flexibility in the set-up and layout of the performance and audience areas.", 
            images:["https://img.bcu.ac.uk/_bcuimages/tom-bird-birmingham-conservatoire-8-131600601961613750.jpg","https://tse3.mm.bing.net/th/id/OIP.KVLOD-33YQ_4lm-3T7IqewHaE8?pid=Api","https://tse3.mm.bing.net/th/id/OIP.y1fzC3dK3PyZjZh6JcXCjAHaE8?pid=Api"]
        },
        Workshop:{
            alt: "Workshops / Performance Studios",
            desc:"Eight 30-60 capacity performance studios sit at the heart of the Conservatoire that have been designed to the highest artistic and commercial standards for the professional training of our musicians and actors. High ceilings, large windows and spacious open floor areas enable flexible spaces that are equally suited for the development of performance activity, as they are in providing a refined backdrop for conferences and meetings, or as the starting point to be dressed for functions and receptions. Each studio has a timber hardwood floor, grand piano, B&W surround sound or stereo system, laser projector and screen with wireless presentation connectivity", 
            images:["https://img.bcu.ac.uk/_bcuimages/copyright-hufton-crow-2-131600605710728764.jpg","https://img.bcu.ac.uk/_bcuimages/natalie-haas-cello-workshop-133970508075817499.jpg"]
        }
    };
    const venueKeys = Object.keys(venueDetails);

    // --- 2. GRAB DOM ELEMENTS ---

    // Tabs & Pages
    const venuePage = document.getElementById('venuePage');
    const venueTab = document.getElementById('venueTab');
    const staffTab = document.getElementById('staffTab');
    const clearSessionBtn = document.getElementById('clearSession');

    // Form Inputs
    const startTimeSelect = document.getElementById('startTime');
    const endTimeSelect = document.getElementById('endTime');
    const dayCheckboxes = document.querySelectorAll('.day');
    const venueSelect = document.getElementById('venue');
    const hireTypeSelect = document.getElementById('hireType');
    const equipInputs = {};
    Object.keys(equipmentRates).forEach(key => {
        equipInputs[key] = document.getElementById(`${key}_qty`);
    });

    // Buttons
    const addBtn = document.getElementById('addBtn');
    const emailBtn = document.getElementById('emailBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    // Quote Output
    const orderTableBody = document.getElementById('orderTable').querySelector('tbody');
    const grandTotalEl = document.getElementById('grandTotal');

    // Gallery & Modal
    const venueGallery = document.getElementById('venueGallery');
    const modal = document.getElementById('venueModal');
    const modalContent = modal.querySelector('.modal-content');
    const modalImageContainer = document.getElementById('modalImageContainer');
    const modalDesc = document.getElementById('modalDesc');
    const modalClose = modal.querySelector('.modal-close');
    const modalPrev = modal.querySelector('.modal-prev');
    const modalNext = modal.querySelector('.modal-next');

    // --- 3. HELPER FUNCTIONS ---

    /**
     * Populates time dropdowns with 30-min intervals
     */
    function populateTimes() {
        const fragment = document.createDocumentFragment();
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 30) {
                // Add break: Do not add "23:30" to the list
                if (h === 23 && m === 30) {
                    break; 
                }
                const hour = h.toString().padStart(2, '0');
                const min = m.toString().padStart(2, '0');
                const time = `${hour}:${min}`;
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                fragment.appendChild(option);
            }
        }
        startTimeSelect.appendChild(fragment.cloneNode(true));
        endTimeSelect.appendChild(fragment);

        // Set default sensible times
        startTimeSelect.value = "09:00";
        endTimeSelect.value = "17:00";
    }

    /**
     * Converts "HH:MM" string to a decimal number (e.g., "09:30" -> 9.5)
     * @param {string} timeStr - The time string
     * @returns {number} The decimal representation of the time
     */
    function parseTime(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours + (minutes / 60);
    }

    /**
     * Calculates total after-hours surcharge for a set of days and times
     * @param {Array} selectedDays - Array of day abbreviation strings (e.g., ["Mon", "Sat"])
     * @param {number} startTime - Decimal start time
     * @param {number} endTime - Decimal end time
     * @returns {number} The total surcharge amount in £
     */
    function calculateAfterHoursSurcharge(selectedDays, startTime, endTime) {
        let totalAfterHours = 0;

        selectedDays.forEach(day => {
            const isWeekend = (day === 'Sat' || day === 'Sun');
            const regStart = 8.0;
            const regEnd = isWeekend ? 19.0 : 23.0;

            const earlyHours = Math.max(0, regStart - startTime);
            const lateHours = Math.max(0, endTime - regEnd);

            totalAfterHours += (earlyHours + lateHours);
        });

        return totalAfterHours * AFTER_HOURS_SURCHARGE_RATE;
    }

    /**
     * Recalculates and updates the grand total from all rows
     */
    function updateGrandTotal() {
        let total = 0;
        orderTableBody.querySelectorAll('tr').forEach(row => {
            // Get total from the 8th cell (index 7)
            const totalCell = row.cells[7];
            if (totalCell) {
                total += parseFloat(totalCell.dataset.total || '0');
            }
        });
        grandTotalEl.textContent = `Grand Total: £${total.toFixed(2)}`;
    }

    /**
     * Generates a plain-text summary of the quote for email
     * @returns {string} Plain-text quote summary
     */
    function generateEmailBody() {
        let body = "Here is my quote summary:\n\n";
        orderTableBody.querySelectorAll('tr').forEach((row, index) => {
            body += `--- Item ${index + 1} ---\n`;
            body += `Venue: ${row.cells[0].textContent}\n`;
            body += `Hire Type: ${row.cells[1].textContent}\n`;
            body += `Total Hours: ${row.cells[2].textContent}\n`;
            body += `Base Cost: ${row.cells[3].textContent}\n`;
            body += `Equipment: ${row.cells[4].textContent}\n`;
            body += `After-Hours: ${row.cells[8].textContent}\n`;
            body += `Subtotal (ex. VAT): £${(parseFloat(row.cells[5].dataset.subtotal) + parseFloat(row.cells[8].dataset.surcharge)).toFixed(2)}\n`;
            body += `Total (inc. VAT): ${row.cells[7].textContent}\n\n`;
        });
        body += `--------------------\n`;
        body += `${grandTotalEl.textContent}\n\n`;
        body += `Disclaimer: Quote is for reference purposes only. All costs are subject to review.\n`;
        return body;
    }

    /**
     * Generates an HTML string of the quote for download
     * @returns {string} HTML quote summary
     */
    function generateQuoteHTML() {
        const tableHTML = document.getElementById('orderTable').outerHTML;
        const totalHTML = grandTotalEl.outerHTML;
        const disclaimer = `<div class="muted" style="font-family:Arial,sans-serif;color:#6b6b6b;font-size:13px;margin-top:8px;">
            <strong>Disclaimer:</strong> Quote is for reference purposes only. All costs are subject to review.
        </div>`;
        const css = `<style>
            body{font-family:Arial,Helvetica,sans-serif;color:#222;margin:20px;}
            table{width:100%;border-collapse:collapse;margin-top:10px;}
            th, td{border:1px solid #ddd;padding:8px;text-align:center;}
            th{background:#002e5b;color:white;}
            #grandTotal{font-weight:700;font-size:18px;color:#002e5b;text-align:right;margin-top:10px;}
        </style>`;

        return `<!DOCTYPE html><html><head><title>Conservatoire Quote</title>${css}</head><body>
            <h1>Royal Birmingham Conservatoire — Quote Summary</h1>
            ${tableHTML}
            ${totalHTML}
            ${disclaimer}
        </body></html>`;
    }

    // --- 4. EVENT HANDLERS ---

    /**
     * Main function to add a new line item to the quote
     */
    function addQuoteLine() {
        // 1. Get all form values
        const venueKey = venueSelect.value;
        const venueName = venueSelect.options[venueSelect.selectedIndex].text;
        const hireTypeKey = hireTypeSelect.value;
        const hireTypeName = hireTypeSelect.options[hireTypeSelect.selectedIndex].text;
        const startTimeStr = startTimeSelect.value;
        const endTimeStr = endTimeSelect.value;
        const selectedDays = Array.from(dayCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        // 2. Validation
        if (!venueKey) {
            // Re-using the modal for alerts
            alert("Please select a venue.");
            return;
        }
        if (selectedDays.length === 0) {
            alert("Please select at least one event day.");
            return;
        }
        const startTime = parseTime(startTimeStr);
        const endTime = parseTime(endTimeStr);
        if (endTime <= startTime) {
            alert("End time must be after start time.");
            return;
        }

        // 3. Calculations
        // const numDays = selectedDays.length; // No longer needed, will loop
        const hoursPerDay = endTime - startTime;
        const chargeableHoursPerDay = Math.max(MIN_BOOKING_HOURS, hoursPerDay);
        // const totalChargeableHours = chargeableHoursPerDay * numDays; // Will be per-day

        // Base rate
        const baseRate = venueRates[venueKey][hireTypeKey];
        // const baseCost = baseRate * chargeableHoursPerDay * numDays; // Will be per-day

        // --- Loop through each selected day and create a row ---
        selectedDays.forEach((day, index) => {
            const isFirstDay = (index === 0);
            
            // Base cost (per day)
            const baseCost = baseRate * chargeableHoursPerDay;

            // Equipment cost
            let totalEquipCost = 0;
            Object.keys(equipmentRates).forEach(key => {
                const qty = parseInt(equipInputs[key].value, 10) || 0;
                if (qty > 0) {
                    const item = equipmentRates[key];
                    if (item.perDay) {
                        // 'Per day' items are charged on every day's row
                        totalEquipCost += (item.rate * qty);
                    } else if (isFirstDay) {
                        // 'Per booking' items are only charged on the first day's row
                        totalEquipCost += (item.rate * qty);
                    }
                }
            });

            // Surcharge (calculated per individual day)
            const totalSurcharge = calculateAfterHoursSurcharge([day], startTime, endTime);

            // Totals
            const subtotal = baseCost + totalEquipCost; // Subtotal before surcharge & VAT
            const chargeableTotal = subtotal + totalSurcharge; // Total amount to apply VAT to
            const vat = chargeableTotal * VAT_RATE;
            const total = chargeableTotal + vat;

            // 4. Create Table Row
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${venueName} (${day})</td>
                <td>${hireTypeName}</td>
                <td>${chargeableHoursPerDay.toFixed(1)}</td>
                <td>£${baseCost.toFixed(2)}</td>
                <td>£${totalEquipCost.toFixed(2)}</td>
                <td data-subtotal="${subtotal.toFixed(2)}">£${subtotal.toFixed(2)}</td>
                <td>£${vat.toFixed(2)}</td>
                <td data-total="${total.toFixed(2)}"><strong>£${total.toFixed(2)}</strong></td>
                <td data-surcharge="${totalSurcharge.toFixed(2)}">£${totalSurcharge.toFixed(2)}</td>
                <td><button class="removeBtn" style="color:red;border:none;background:none;cursor:pointer;font-size:18px;">✖</button></td>
            `;

            // 5. Add row
            orderTableBody.appendChild(tr);

            // 6. Add remove listener
            tr.querySelector('.removeBtn').addEventListener('click', () => {
                tr.remove();
                updateGrandTotal();
            });
        });

        // 7. Update grand total (after loop)
        updateGrandTotal();

        // 8. Reset equipment quantities (after loop)
        Object.keys(equipInputs).forEach(key => {
            equipInputs[key].value = 0;
        });
    }

    /**
     * Shows a specific image and description in the modal for a venue
     * @param {string} venueKey - The key from venueDetails
     * @param {number} index - The index of the image to show
     */
    function showModalImage(venueKey, index) {
        const details = venueDetails[venueKey];
        if (!details || !details.images || !details.images[index]) return;

        const image = details.images[index];
        const altText = details.alt || venueKey;
        
        modalImageContainer.innerHTML = `<img src="${image}" alt="${altText}" onerror="this.src='https://placehold.co/600x400/002e5b/white?text=${altText}'">`;
        modal.dataset.currentImageIndex = index;
        modal.dataset.currentVenue = venueKey; // Store venue key
        modalDesc.textContent = details.desc; // Set description

        // Toggle arrow visibility
        modalPrev.style.display = (index === 0) ? 'none' : 'block';
        modalNext.style.display = (index === details.images.length - 1) ? 'none' : 'block';
    }


    /**
     * Opens the venue modal with details for the given key
     * @param {string} venueKey - The key from venueDetails (e.g., "Bradshaw")
     */
    function openModal(venueKey) {
        const details = venueDetails[venueKey];
        if (!details) return;

        // Call the new function to show the first image (index 0)
        showModalImage(venueKey, 0); 
        modal.style.display = 'flex';
    }

    /**
     * Closes the venue modal
     */
    function closeModal() {
        modal.style.display = 'none';
    }

    /**
     * Cycles the modal to the next or previous venue
     * @param {number} direction - 1 for next, -1 for previous
     */
    /*
    // This function is no longer needed as arrows now cycle images
    function cycleModal(direction) {
        const currentKey = modal.dataset.current;
        const currentIndex = venueKeys.indexOf(currentKey);
        const newIndex = (currentIndex + direction + venueKeys.length) % venueKeys.length;
        openModal(venueKeys[newIndex]);
    }
    */

    // --- 5. ATTACH EVENT LISTENERS ---

    // Quote Buttons
    addBtn.addEventListener('click', addQuoteLine);

    emailBtn.addEventListener('click', () => {
        if (orderTableBody.rows.length === 0) {
            alert("Please add at least one item to the quote before emailing.");
            return;
        }
        const subject = "Royal Birmingham Conservatoire - Quote Enquiry";
        const body = generateEmailBody();
        window.location.href = `mailto:conservatoireevents@bcu.ac.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    });

    downloadBtn.addEventListener('click', () => {
        if (orderTableBody.rows.length === 0) {
            alert("Please add at least one item to the quote before downloading.");
            return;
        }
        const htmlContent = generateQuoteHTML();
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'conservatoire-quote.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    });

    // Gallery & Modal Listeners
    venueGallery.addEventListener('click', (e) => {
        const panel = e.target.closest('.panel');
        if (panel) {
            openModal(panel.dataset.venue);
        }
    });

    modalClose.addEventListener('click', closeModal);
    
    modalPrev.addEventListener('click', () => {
        const venueKey = modal.dataset.currentVenue;
        const currentIndex = parseInt(modal.dataset.currentImageIndex, 10);
        const newIndex = currentIndex - 1;
        
        if (newIndex >= 0) {
            showModalImage(venueKey, newIndex);
        }
    });

    modalNext.addEventListener('click', () => {
        const venueKey = modal.dataset.currentVenue;
        const details = venueDetails[venueKey];
        const currentIndex = parseInt(modal.dataset.currentImageIndex, 10);
        const newIndex = currentIndex + 1;

        if (newIndex < details.images.length) {
            showModalImage(venueKey, newIndex);
        }
    });

    modal.addEventListener('click', (e) => {
        // Close if clicking on the dark background, but not the content
        if (e.target === modal) {
            closeModal();
        }
    });

    // Tab Listeners (Basic)
    venueTab.addEventListener('click', () => {
        venuePage.style.display = 'block';
        // In a real app, you'd hide the staff page here
    });
    
    staffTab.addEventListener('click', () => {
        // This is just a placeholder action as the staff page isn't built
        alert("Staffing page is not implemented in this demo.");
    });

    if (clearSessionBtn) {
        clearSessionBtn.addEventListener('click', (e) => {
            e.preventDefault();
            alert('Staff session cleared (demo).');
        });
    }

    // --- 6. INITIALIZE PAGE ---

    populateTimes();

});
</script>

</div>
</body>
</html>


