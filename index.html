document.addEventListener('DOMContentLoaded', () => {

    // --- 1. DEFINE DATA (Rates & Venue Details) ---

    const VAT_RATE = 0.20;
    const AFTER_HOURS_SURCHARGE_RATE = 20; // £ per hour
    const MIN_BOOKING_HOURS = 4;

    // Venue hire rates (per hour)
    const venueRates = {
        Bradshaw: { standard: 220, premium: 160 },
        Recital: { standard: 150, premium: 110 },
        Lab: { standard: 100, premium: 80 },
        Jazz: { standard: 120, premium: 90 },
        Organ: { standard: 80, premium: 60 },
        Workshop: { standard: 70, premium: 50 }
    };

    // Equipment rates
    const equipmentRates = {
        pa: { rate: 100, perDay: true },
        projector: { rate: 50, perDay: true },
        mic_wired: { rate: 10, perDay: false },
        mic_wireless: { rate: 25, perDay: false },
        monitor: { rate: 15, perDay: false },
        overhead: { rate: 75, perDay: false },
        video: { rate: 75, perDay: false },
        laptop: { rate: 30, perDay: false },
        piano: { rate: 50, perDay: false }
    };

    // Data for the modal gallery
    const venueDetails = {
        Bradshaw: {
            img: "https://img.bcu.ac.uk/_bcuimages/copyright-hufton-crow-24-131600593110714462.jpg",
            alt: "Bradshaw Hall",
            desc: "The Bradshaw Hall is our 500-seat main concert hall, acoustically designed for exceptional orchestral and ensemble performances. It features a full orchestra platform and state-of-the-art lighting and sound."
        },
        Recital: {
            img: "https://img.bcu.ac.uk/_bcuimages/tom-bird-birmingham-conservatoire-27-131600597991399988.jpg",
            alt: "Recital Hall",
            desc: "An intimate 150-seat space, the Recital Hall is perfect for solo performances, chamber music, and masterclasses. It offers a warm acoustic and a direct connection with the audience."
        },
        Jazz: {
            img: "https://img.bcu.ac.uk/_bcuimages/tom-bird-birmingham-conservatoire-25-131600600782377259.jpg",
            alt: "Eastside Jazz Club",
            desc: "Our dedicated Eastside Jazz Club, with a capacity of 100, is a modern and relaxed venue designed specifically for jazz and contemporary music, complete with bar and café-style seating."
        },
        Organ: {
            img: "https://img.bcu.ac.uk/_bcuimages/tom-bird-birmingham-conservatoire-8-131600601961613750.jpg",
            alt: "Organ Studio",
            desc: "The Organ Studio features a bespoke 3-manual, 43-stop concert pipe organ. This specialist space is designed for both practice and performance, offering a unique and resonant sound."
        },
        Lab: {
            img: "https://img.bcu.ac.uk/_bcuimages/copyright-hufton-crow-30-131600603623200315.jpg",
            alt: "The Lab",
            desc: "The Lab is our 100-seat, flexible, black-box experimental studio. It is ideal for contemporary, electronic, and cross-disciplinary work, with adaptable staging and A/V technology."
        },
        Workshop: {
            img: "https://img.bcu.ac.uk/_bcuimages/copyright-hufton-crow-2-131600605710728764.jpg",
            alt: "Workshops / Performance Studios",
            desc: "We have several large, acoustically isolated workshop and performance studios. These spaces are ideal for rehearsals, workshops, and smaller-scale performances."
        }
    };
    const venueKeys = Object.keys(venueDetails);

    // --- 2. GRAB DOM ELEMENTS ---

    // Tabs & Pages
    const venuePage = document.getElementById('venuePage');
    const venueTab = document.getElementById('venueTab');
    const staffTab = document.getElementById('staffTab');
    const clearSessionBtn = document.getElementById('clearSession');

    // Form Inputs
    const startTimeSelect = document.getElementById('startTime');
    const endTimeSelect = document.getElementById('endTime');
    const dayCheckboxes = document.querySelectorAll('.day');
    const venueSelect = document.getElementById('venue');
    const hireTypeSelect = document.getElementById('hireType');
    const equipInputs = {};
    Object.keys(equipmentRates).forEach(key => {
        equipInputs[key] = document.getElementById(`${key}_qty`);
    });

    // Buttons
    const addBtn = document.getElementById('addBtn');
    const emailBtn = document.getElementById('emailBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    // Quote Output
    const orderTableBody = document.getElementById('orderTable').querySelector('tbody');
    const grandTotalEl = document.getElementById('grandTotal');

    // Gallery & Modal
    const venueGallery = document.getElementById('venueGallery');
    const modal = document.getElementById('venueModal');
    const modalContent = modal.querySelector('.modal-content');
    const modalImageContainer = document.getElementById('modalImageContainer');
    const modalDesc = document.getElementById('modalDesc');
    const modalClose = modal.querySelector('.modal-close');
    const modalPrev = modal.querySelector('.modal-prev');
    const modalNext = modal.querySelector('.modal-next');

    // --- 3. HELPER FUNCTIONS ---

    /**
     * Populates time dropdowns with 30-min intervals
     */
    function populateTimes() {
        const fragment = document.createDocumentFragment();
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 30) {
                const hour = h.toString().padStart(2, '0');
                const min = m.toString().padStart(2, '0');
                const time = `${hour}:${min}`;
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                fragment.appendChild(option);
            }
        }
        startTimeSelect.appendChild(fragment.cloneNode(true));
        endTimeSelect.appendChild(fragment);

        // Set default sensible times
        startTimeSelect.value = "09:00";
        endTimeSelect.value = "17:00";
    }

    /**
     * Converts "HH:MM" string to a decimal number (e.g., "09:30" -> 9.5)
     * @param {string} timeStr - The time string
     * @returns {number} The decimal representation of the time
     */
    function parseTime(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours + (minutes / 60);
    }

    /**
     * Calculates total after-hours surcharge for a set of days and times
     * @param {Array} selectedDays - Array of day abbreviation strings (e.g., ["Mon", "Sat"])
     * @param {number} startTime - Decimal start time
     * @param {number} endTime - Decimal end time
     * @returns {number} The total surcharge amount in £
     */
    function calculateAfterHoursSurcharge(selectedDays, startTime, endTime) {
        let totalAfterHours = 0;

        selectedDays.forEach(day => {
            const isWeekend = (day === 'Sat' || day === 'Sun');
            const regStart = 8.0;
            const regEnd = isWeekend ? 19.0 : 23.0;

            const earlyHours = Math.max(0, regStart - startTime);
            const lateHours = Math.max(0, endTime - regEnd);

            totalAfterHours += (earlyHours + lateHours);
        });

        return totalAfterHours * AFTER_HOURS_SURCHARGE_RATE;
    }

    /**
     * Recalculates and updates the grand total from all rows
     */
    function updateGrandTotal() {
        let total = 0;
        orderTableBody.querySelectorAll('tr').forEach(row => {
            // Get total from the 8th cell (index 7)
            const totalCell = row.cells[7];
            if (totalCell) {
                total += parseFloat(totalCell.dataset.total || '0');
            }
        });
        grandTotalEl.textContent = `Grand Total: £${total.toFixed(2)}`;
    }

    /**
     * Generates a plain-text summary of the quote for email
     * @returns {string} Plain-text quote summary
     */
    function generateEmailBody() {
        let body = "Here is my quote summary:\n\n";
        orderTableBody.querySelectorAll('tr').forEach((row, index) => {
            body += `--- Item ${index + 1} ---\n`;
            body += `Venue: ${row.cells[0].textContent}\n`;
            body += `Hire Type: ${row.cells[1].textContent}\n`;
            body += `Total Hours: ${row.cells[2].textContent}\n`;
            body += `Base Cost: ${row.cells[3].textContent}\n`;
            body += `Equipment: ${row.cells[4].textContent}\n`;
            body += `After-Hours: ${row.cells[8].textContent}\n`;
            body += `Subtotal (ex. VAT): £${(parseFloat(row.cells[5].dataset.subtotal) + parseFloat(row.cells[8].dataset.surcharge)).toFixed(2)}\n`;
            body += `Total (inc. VAT): ${row.cells[7].textContent}\n\n`;
        });
        body += `--------------------\n`;
        body += `${grandTotalEl.textContent}\n\n`;
        body += `Disclaimer: Quote is for reference purposes only. All costs are subject to review.\n`;
        return body;
    }

    /**
     * Generates an HTML string of the quote for download
     * @returns {string} HTML quote summary
     */
    function generateQuoteHTML() {
        const tableHTML = document.getElementById('orderTable').outerHTML;
        const totalHTML = grandTotalEl.outerHTML;
        const disclaimer = `<div class="muted" style="font-family:Arial,sans-serif;color:#6b6b6b;font-size:13px;margin-top:8px;">
            <strong>Disclaimer:</strong> Quote is for reference purposes only. All costs are subject to review.
        </div>`;
        const css = `<style>
            body{font-family:Arial,Helvetica,sans-serif;color:#222;margin:20px;}
            table{width:100%;border-collapse:collapse;margin-top:10px;}
            th, td{border:1px solid #ddd;padding:8px;text-align:center;}
            th{background:#002e5b;color:white;}
            #grandTotal{font-weight:700;font-size:18px;color:#002e5b;text-align:right;margin-top:10px;}
        </style>`;

        return `<!DOCTYPE html><html><head><title>Conservatoire Quote</title>${css}</head><body>
            <h1>Royal Birmingham Conservatoire — Quote Summary</h1>
            ${tableHTML}
            ${totalHTML}
            ${disclaimer}
        </body></html>`;
    }

    // --- 4. EVENT HANDLERS ---

    /**
     * Main function to add a new line item to the quote
     */
    function addQuoteLine() {
        // 1. Get all form values
        const venueKey = venueSelect.value;
        const venueName = venueSelect.options[venueSelect.selectedIndex].text;
        const hireTypeKey = hireTypeSelect.value;
        const hireTypeName = hireTypeSelect.options[hireTypeSelect.selectedIndex].text;
        const startTimeStr = startTimeSelect.value;
        const endTimeStr = endTimeSelect.value;
        const selectedDays = Array.from(dayCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        // 2. Validation
        if (!venueKey) {
            alert("Please select a venue.");
            return;
        }
        if (selectedDays.length === 0) {
            alert("Please select at least one event day.");
            return;
        }
        const startTime = parseTime(startTimeStr);
        const endTime = parseTime(endTimeStr);
        if (endTime <= startTime) {
            alert("End time must be after start time.");
            return;
        }

        // 3. Calculations
        const numDays = selectedDays.length;
        const hoursPerDay = endTime - startTime;
        const chargeableHoursPerDay = Math.max(MIN_BOOKING_HOURS, hoursPerDay);
        const totalChargeableHours = chargeableHoursPerDay * numDays;

        // Base cost
        const baseRate = venueRates[venueKey][hireTypeKey];
        const baseCost = baseRate * chargeableHoursPerDay * numDays;

        // Equipment cost
        let totalEquipCost = 0;
        Object.keys(equipmentRates).forEach(key => {
            const qty = parseInt(equipInputs[key].value, 10) || 0;
            if (qty > 0) {
                const item = equipmentRates[key];
                const costPerItem = item.rate * (item.perDay ? numDays : 1);
                totalEquipCost += costPerItem * qty;
            }
        });

        // Surcharge
        const totalSurcharge = calculateAfterHoursSurcharge(selectedDays, startTime, endTime);

        // Totals
        const subtotal = baseCost + totalEquipCost; // Subtotal before surcharge & VAT
        const chargeableTotal = subtotal + totalSurcharge; // Total amount to apply VAT to
        const vat = chargeableTotal * VAT_RATE;
        const total = chargeableTotal + vat;

        // 4. Create Table Row
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${venueName}</td>
            <td>${hireTypeName}</td>
            <td>${totalChargeableHours.toFixed(1)} (${chargeableHoursPerDay.toFixed(1)} x ${numDays}d)</td>
            <td>£${baseCost.toFixed(2)}</td>
            <td>£${totalEquipCost.toFixed(2)}</td>
            <td data-subtotal="${subtotal.toFixed(2)}">£${subtotal.toFixed(2)}</td>
            <td>£${vat.toFixed(2)}</td>
            <td data-total="${total.toFixed(2)}"><strong>£${total.toFixed(2)}</strong></td>
            <td data-surcharge="${totalSurcharge.toFixed(2)}">£${totalSurcharge.toFixed(2)}</td>
            <td><button class="removeBtn" style="color:red;border:none;background:none;cursor:pointer;">✖</button></td>
        `;

        // 5. Add row and update total
        orderTableBody.appendChild(tr);
        updateGrandTotal();

        // 6. Add remove listener
        tr.querySelector('.removeBtn').addEventListener('click', () => {
            tr.remove();
            updateGrandTotal();
        });

        // 7. Reset equipment quantities
        Object.keys(equipInputs).forEach(key => {
            equipInputs[key].value = 0;
        });
    }

    /**
     * Opens the venue modal with details for the given key
     * @param {string} venueKey - The key from venueDetails (e.g., "Bradshaw")
     */
    function openModal(venueKey) {
        const details = venueDetails[venueKey];
        if (!details) return;

        modalImageContainer.innerHTML = `<img src="${details.img}" alt="${details.alt}">`;
        modalDesc.textContent = details.desc;
        modal.dataset.current = venueKey; // Store current key for arrows
        modal.style.display = 'flex';
        // Pre-load next/prev images
        const currentIndex = venueKeys.indexOf(venueKey);
        const nextKey = venueKeys[(currentIndex + 1) % venueKeys.length];
        const prevKey = venueKeys[(currentIndex - 1 + venueKeys.length) % venueKeys.length];
        new Image().src = venueDetails[nextKey].img;
        new Image().src = venueDetails[prevKey].img;
    }

    /**
     * Closes the venue modal
     */
    function closeModal() {
        modal.style.display = 'none';
    }

    /**
     * Cycles the modal to the next or previous venue
     * @param {number} direction - 1 for next, -1 for previous
     */
    function cycleModal(direction) {
        const currentKey = modal.dataset.current;
        const currentIndex = venueKeys.indexOf(currentKey);
        const newIndex = (currentIndex + direction + venueKeys.length) % venueKeys.length;
        openModal(venueKeys[newIndex]);
    }

    // --- 5. ATTACH EVENT LISTENERS ---

    // Quote Buttons
    addBtn.addEventListener('click', addQuoteLine);

    emailBtn.addEventListener('click', () => {
        if (orderTableBody.rows.length === 0) {
            alert("Please add at least one item to the quote before emailing.");
            return;
        }
        const subject = "Royal Birmingham Conservatoire - Quote Enquiry";
        const body = generateEmailBody();
        window.location.href = `mailto:conservatoireevents@bcu.ac.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    });

    downloadBtn.addEventListener('click', () => {
        if (orderTableBody.rows.length === 0) {
            alert("Please add at least one item to the quote before downloading.");
            return;
        }
        const htmlContent = generateQuoteHTML();
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'conservatoire-quote.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    });

    // Gallery & Modal Listeners
    venueGallery.addEventListener('click', (e) => {
        const panel = e.target.closest('.panel');
        if (panel) {
            openModal(panel.dataset.venue);
        }
    });

    modalClose.addEventListener('click', closeModal);
    modalPrev.addEventListener('click', () => cycleModal(-1));
    modalNext.addEventListener('click', () => cycleModal(1));
    modal.addEventListener('click', (e) => {
        // Close if clicking on the dark background, but not the content
        if (e.target === modal) {
            closeModal();
        }
    });

    // Tab Listeners (Basic)
    venueTab.addEventListener('click', () => {
        venuePage.style.display = 'block';
        // In a real app, you'd hide the staff page here
    });
    
    staffTab.addEventListener('click', () => {
        venuePage.style.display = 'none';
        // In a real app, you'd show the staff page here
        // For this demo, we'll just show an alert and re-show the venue page
        alert("Staffing page is not part of this code snippet.");
        venuePage.style.display = 'block'; 
    });

    if (clearSessionBtn) {
        clearSessionBtn.addEventListener('click', () => {
            alert('Staff session cleared (demo).');
        });
    }

    // --- 6. INITIALIZE PAGE ---

    populateTimes();

});
